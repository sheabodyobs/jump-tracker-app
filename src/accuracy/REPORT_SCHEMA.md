# Accuracy Report Schema

Machine-readable JSON schema for golden dataset test results.

**Generated by**: `src/accuracy/runAccuracy.ts`  
**Output path**: `datasets/gct-golden/reports/latest.json`

---

## Top-Level Structure

```typescript
interface AccuracyReport {
  timestamp: string;              // ISO 8601 timestamp of report generation
  version: string;                // Schema version (e.g., "1.0.0")
  
  numTotalCases: number;          // Total test cases in manifest
  numAcceptCases: number;         // Cases with shouldAccept: true
  numRejectCases: number;         // Cases with shouldAccept: false
  numSkipped: number;             // Cases without frame cache
  numErrors: number;              // Cases with runtime errors
  
  cases: CaseResult[];            // Per-case results
  global?: GlobalMetrics;         // Aggregated metrics across cases
  rejectMetrics?: RejectMetrics;  // Rejection/false-accept rates
  summary: Summary;               // Overall pass/fail
}
```

---

## CaseResult

Result for a single test case.

```typescript
interface CaseResult {
  caseId: string;                 // Test case ID (e.g., "pogo_tripod_good_01")
  status: 'accept' | 'reject' | 'skip' | 'error';
  
  skipReason?: string;            // Why skipped (e.g., "no frame cache")
  errorReason?: string;           // Error message if status='error'
  
  // Expected outcome from manifest
  expectedAccept: boolean;        // manifest.cases[i].expected.shouldAccept
  expectedThresholds?: {
    maxMedianGctErrMs?: number;
    maxP95GctErrMs?: number;
    maxMedianFlightErrMs?: number;
    maxP95FlightErrMs?: number;
    maxMedianLandingErrMs?: number;
    maxP95LandingErrMs?: number;
    maxMedianTakeoffErrMs?: number;
    maxP95TakeoffErrMs?: number;
  };
  
  // Pipeline results
  pipelineAccepted?: boolean;     // Whether offline pipeline accepted the video
  autoMetrics?: JumpMetrics | null;
  
  // Error metrics (only if pipelineAccepted=true and expectedAccept=true)
  landingErrorsMs?: number[];     // Absolute error per matched landing (ms)
  takeoffErrorsMs?: number[];     // Absolute error per matched takeoff (ms)
  gctErrorsMs?: number[];         // Ground contact time error per matched hop (ms)
  flightErrorsMs?: number[];      // Flight time (takeoff - landing) error (ms)
  
  // Unmatched events (within toleranceMs)
  unmatchedAutoLandings?: number;
  unmatchedAutoTakeoffs?: number;
  unmatchedLabelLandings?: number;
  unmatchedLabelTakeoffs?: number;
  
  // Computed summary metrics
  metrics?: {
    numMatches: number;           // Number of matched hops
    medianLandingErrMs?: number;  // Median of landingErrorsMs
    p95LandingErrMs?: number;     // 95th percentile of landingErrorsMs
    medianTakeoffErrMs?: number;
    p95TakeoffErrMs?: number;
    medianGctErrMs?: number;
    p95GctErrMs?: number;
    medianFlightErrMs?: number;
    p95FlightErrMs?: number;
  };
  
  // Threshold validation
  thresholdPassed?: boolean;
  thresholdFailures?: string[];   // Which thresholds were exceeded
}
```

### Status Meanings

| Status | Meaning |
|--------|---------|
| `accept` | Pipeline accepted AND passed threshold checks (or correctly rejected when expectedAccept=false) |
| `reject` | Pipeline rejected when it should have accepted, OR accepted when it should have rejected |
| `skip` | No frame cache available; case not evaluated |
| `error` | Runtime error during processing |

### Example: Good Accept Case

```json
{
  "caseId": "pogo_tripod_good_01",
  "status": "accept",
  "expectedAccept": true,
  "expectedThresholds": {
    "maxMedianGctErrMs": 15,
    "maxP95GctErrMs": 40
  },
  "pipelineAccepted": true,
  "landingErrorsMs": [8, 12, 5],
  "takeoffErrorsMs": [10, 7, 3],
  "gctErrorsMs": [2, -5, -2],
  "flightErrorsMs": [5, 2, 8],
  "unmatchedAutoLandings": 0,
  "unmatchedAutoTakeoffs": 0,
  "unmatchedLabelLandings": 0,
  "unmatchedLabelTakeoffs": 0,
  "metrics": {
    "numMatches": 3,
    "medianLandingErrMs": 8,
    "p95LandingErrMs": 11.6,
    "medianTakeoffErrMs": 7,
    "p95TakeoffErrMs": 9.2,
    "medianGctErrMs": -2,
    "p95GctErrMs": 1.6,
    "medianFlightErrMs": 5,
    "p95FlightErrMs": 7.6
  },
  "thresholdPassed": true
}
```

### Example: Correctly Rejected Case

```json
{
  "caseId": "pogo_low_light_01",
  "status": "accept",
  "expectedAccept": false,
  "pipelineAccepted": false,
  "autoMetrics": null
}
```

### Example: False Accept (Should have Rejected)

```json
{
  "caseId": "pogo_camera_motion_01",
  "status": "reject",
  "expectedAccept": false,
  "pipelineAccepted": true,
  "autoMetrics": { ... },
  "metrics": { ... }
}
```

### Example: Reject Error (Should have Accepted)

```json
{
  "caseId": "pogo_tripod_good_01",
  "status": "reject",
  "expectedAccept": true,
  "pipelineAccepted": false,
  "autoMetrics": null
}
```

### Example: Threshold Failure

```json
{
  "caseId": "pogo_floor_good_01",
  "status": "accept",
  "expectedAccept": true,
  "expectedThresholds": {
    "maxMedianGctErrMs": 15,
    "maxP95GctErrMs": 40
  },
  "pipelineAccepted": true,
  "metrics": {
    "numMatches": 2,
    "medianGctErrMs": 22,
    "p95GctErrMs": 35
  },
  "thresholdPassed": false,
  "thresholdFailures": [
    "medianGctErr 22.0ms > 15ms"
  ]
}
```

### Example: Skipped (No Cache)

```json
{
  "caseId": "pogo_stiffness_test_01",
  "status": "skip",
  "expectedAccept": true,
  "skipReason": "no frame cache"
}
```

---

## GlobalMetrics

Aggregated metrics across all cases that were successfully analyzed (accept cases that ran).

```typescript
interface GlobalMetrics {
  numCasesAnalyzed: number;       // Accept cases that weren't skipped/errored
  numMatchedHops: number;         // Total matched hops across cases
  
  // Aggregated error distributions
  medianGctErrMs: number;         // Median of all GCT errors across cases
  p95GctErrMs: number;            // 95th percentile of all GCT errors
  medianLandingErrMs: number;
  p95LandingErrMs: number;
  medianTakeoffErrMs: number;
  p95TakeoffErrMs: number;
  medianFlightErrMs: number;
  p95FlightErrMs: number;
}
```

### Percentile Calculation

Uses **nearest-rank method** (deterministic):

```
rank = ceil(p / 100 * n) - 1
result = sorted[rank]
```

For reproducibility, this is the same calculation used by numpy's `percentile(..., interpolation='lower')`.

### Example

```json
"global": {
  "numCasesAnalyzed": 5,
  "numMatchedHops": 18,
  "medianGctErrMs": 8.5,
  "p95GctErrMs": 35.2,
  "medianLandingErrMs": 6.0,
  "p95LandingErrMs": 12.8,
  "medianTakeoffErrMs": 7.5,
  "p95TakeoffErrMs": 14.1,
  "medianFlightErrMs": 5.0,
  "p95FlightErrMs": 18.3
}
```

---

## RejectMetrics

Metrics for rejection behavior (false rejects and false accepts).

```typescript
interface RejectMetrics {
  shouldAcceptCount: number;      // Cases with expectedAccept=true
  actuallyRejectedCount: number;  // Cases that should accept but pipeline rejected
  rejectRate: number;             // actuallyRejectedCount / shouldAcceptCount * 100
  
  shouldRejectCount: number;      // Cases with expectedAccept=false
  falseAcceptCount: number;       // Cases that should reject but pipeline accepted
  falseAcceptRate: number;        // falseAcceptCount / shouldRejectCount * 100
}
```

### Interpretation

- **rejectRate**: % of cases where pipeline failed to accept when it should have
- **falseAcceptRate**: % of cases where pipeline incorrectly accepted invalid videos

Both should be 0% for perfect rejection behavior.

### Example

```json
"rejectMetrics": {
  "shouldAcceptCount": 10,
  "actuallyRejectedCount": 1,
  "rejectRate": 10.0,
  "shouldRejectCount": 5,
  "falseAcceptCount": 0,
  "falseAcceptRate": 0.0
}
```

---

## Summary

Overall pass/fail verdict.

```typescript
interface Summary {
  allThresholdsPassed: boolean;   // All accept cases met their thresholds
  casesFailedThresholds: string[]; // Case IDs that failed
}
```

### Example

```json
"summary": {
  "allThresholdsPassed": false,
  "casesFailedThresholds": [
    "pogo_floor_good_01",
    "pogo_multibounce_good_01"
  ]
}
```

---

## Error Metrics Definitions

### Landing Error

Absolute difference between auto-detected landing time and ground-truth landing time:

```
landingError = |auto_landing - label_landing|
```

### Takeoff Error

Absolute difference between auto-detected takeoff time and ground-truth takeoff time:

```
takeoffError = |auto_takeoff - label_takeoff|
```

### Ground Contact Time (GCT) Error

Absolute difference in duration of ground contact:

```
auto_gct = auto_takeoff - auto_landing
label_gct = label_takeoff - label_landing
gctError = |auto_gct - label_gct|
```

Note: Can be negative if auto-detected GCT is shorter than ground truth.

### Flight Time Error

Absolute difference in duration of airtime (between successive ground contacts):

```
auto_flight = next_auto_landing - auto_takeoff
label_flight = next_label_landing - label_takeoff
flightError = |auto_flight - label_flight|
```

---

## Event Matching Strategy

1. **Nearest Neighbor Matching** with tolerance:
   - For each auto-detected event, find closest ground-truth event
   - Only match if distance ≤ `toleranceMs` (from manifest labels)
   - Each ground-truth event matched at most once

2. **Unmatched Events**:
   - Auto events with no nearby ground truth → `unmatchedAutoLandings`
   - Ground-truth events with no nearby auto detection → `unmatchedLabelLandings`

3. **Hop Pairing**:
   - Pair each landing with the next takeoff (greedy, same-direction)
   - Match hops by landing time (within tolerance)
   - Compute GCT error from paired hops

---

## Console Output

Alongside the JSON report, `runAccuracy` prints a concise text summary:

```
ACCURACY SUMMARY
============================================================

Cases: 15 total
  - Accept: 10
  - Reject: 5
  - Skipped: 0
  - Errors: 0

Reject Rate: 10.0%
  - Should accept: 10
  - Actually rejected: 1

False Accept Rate: 0.0%
  - Should reject: 5
  - Actually accepted: 0

Global Metrics (10 cases analyzed)
  - Matched hops: 28
  - Median GCT error: 8.5ms
  - P95 GCT error: 35.2ms
  - Median flight error: 5.0ms
  - P95 flight error: 18.3ms

All Thresholds Passed: NO ✗
  Failed cases: pogo_floor_good_01, pogo_multibounce_good_01
============================================================
```

---

## File Paths

```
datasets/gct-golden/
├── manifest.json                          # Test case specs
├── reports/
│   └── latest.json                        # Latest accuracy report
├── cases/
│   ├── pogo_tripod_good_01/
│   │   ├── frames.json                    # Frame metadata
│   │   └── gray.bin                       # Grayscale frame data
│   ├── pogo_low_light_01/
│   │   ├── frames.json
│   │   └── gray.bin
│   └── ...
└── videos/                                # Original .mov files
    ├── pogo_tripod_good_01.mov
    └── ...
```

---

## Usage in CI/CD

1. **Locally**: Run `npm run accuracy:run` to generate report
2. **CI Pipeline**:
   ```bash
   npm run accuracy:run
   ```
   Check exit code (0 = all thresholds passed, 1 = failures)

3. **Regression Detection**:
   - Compare `latest.json` to previous run
   - Alert if `allThresholdsPassed` changed from true to false
   - Track `global.medianGctErrMs` over time

4. **Pretty Print**:
   ```bash
   npm run accuracy:report
   ```
   Prints human-readable summary (optional tool)

---

**Version**: 1.0.0  
**Last Updated**: January 21, 2026
